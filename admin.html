<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Order Dashboard – Mehta Masala</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="assets/css/style.css">

    <style>
        body { background:#f7fdf8; }
        .admin-container { max-width:1100px; margin:80px auto 40px; background:#fff; border-radius:16px; padding:24px; box-shadow:0 12px 30px rgba(0,0,0,0.05);}
        .admin-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .admin-header h1 { font-size:24px; color:#2C7A52; margin:0; }
        table { width:100%; border-collapse:collapse; margin-top:10px;}
        th, td { padding:10px 8px; font-size:14px; border-bottom:1px solid #eee; text-align:left;}
        th { background:#f5faf7; color:#2C7A52; font-weight:600;}
        tr:hover { background:#f9fdfb; }
        .empty-row { text-align:center; padding:20px; color:#777;}
    </style>
</head>
<body>
<div class="admin-header">
    <div class="left-menu">
        <h2>Mehta Masala Admin</h2>
        <a href="admin.html">Orders</a>
        <a href="#">Products (coming soon)</a>
        <a href="#">Settings (coming soon)</a>
    </div>

    <button class="logout-btn" onclick="logoutAdmin()">Logout</button>
</div>
<script>
    // Redirect if not logged in
    document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("adminToken");
        if (!token) {
            window.location.href = "admin-login.html";
        }
    });

    function logoutAdmin() {
        localStorage.removeItem("adminToken");
        window.location.href = "admin-login.html";
    }
</script>
<script>
    const API = "https://mehta-masala-backend.onrender.com";

    // Runs after the page is loaded
    document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("adminToken");

        // If no token → send to login
        if (!token) {
            window.location.href = "admin-login.html";
            return;
        }

        // Load orders with the token
        loadOrders(token);
    });

    // Logout button click
    function logoutAdmin() {
        localStorage.removeItem("adminToken");
        window.location.href = "admin-login.html";
    }

    // Step 5: this is the loadOrders function
    async function loadOrders(token) {
        const tbody = document.getElementById("orders-body");

        try {
            const res = await fetch(API + "/admin/orders", {
                headers: { "Authorization": token }
            });

            const data = await res.json();

            if (!data.success) {
                // Token invalid or server error → force login again
                tbody.innerHTML = `<tr><td colspan="8" class="empty-row">Auth error – please login again.</td></tr>`;
                setTimeout(() => window.location.href = "admin-login.html", 1500);
                return;
            }

            renderOrders(data.orders);
        } catch (err) {
            console.error("Error loading orders:", err);
            tbody.innerHTML = `<tr><td colspan="8" class="empty-row">Error loading orders. Please refresh.</td></tr>`;
        }
    }

    // Render table rows
    function renderOrders(rows) {
        const tbody = document.getElementById("orders-body");

        if (!rows || !rows.length) {
            tbody.innerHTML = `<tr><td colspan="8" class="empty-row">No orders found.</td></tr>`;
            return;
        }

        tbody.innerHTML = rows.map(o => `
            <tr>
                <td>${o.created_at}</td>
                <td>${o.order_id}</td>
                <td>${o.customer_name}</td>
                <td>${o.customer_city}</td>
                <td>${o.customer_phone}</td>
                <td>${o.total_amount}</td>
                <td>${o.payment_status}</td>
                <td>${o.payment_method}</td>
            </tr>
        `).join('');
    }
</script>

<header class="site-header">
    <div class="container header-inner">
        <a href="index.html" class="logo">
            <img src="assets/images/logo.svg" alt="Mehta Masala Logo">
        </a>
        <nav class="main-nav">
            <a href="index.html">Home</a>
            <a href="about.html">About Us</a>
            <a href="products.html">Shop</a>
            <a href="contact.html">Contact</a>
        </nav>
    </div>
</header>

<main>
    <section class="admin-container">
        <div class="admin-header">
            <h1>Orders Dashboard</h1>
        </div>

        <table>
            <thead>
            <tr>
                <th>Date</th>
                <th>Order ID</th>
                <th>Name</th>
                <th>City</th>
                <th>Phone</th>
                <th>Total</th>
                <th>Payment Status</th>
                <th>Payment Method</th>
            </tr>
            </thead>
            <tbody id="orders-body">
            <tr><td colspan="8" class="empty-row">Loading orders…</td></tr>
            </tbody>
        </table>
    </section>
</main>

</body>
</html>